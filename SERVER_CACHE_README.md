# Server-Side Audio Caching for Motion Canvas Narrator

This feature extends the Motion Canvas Narrator library with server-side audio file caching, similar to how the Motion Canvas exporter works. Audio files generated by providers (like ElevenLabs) are now automatically uploaded to and cached on the server via WebSocket connections.

## Benefits

- **Persistent Storage**: Audio files persist across browser sessions and page refreshes
- **Team Collaboration**: Cached audio files are shared across team members working on the same project
- **Reduced API Costs**: Avoid regenerating the same audio multiple times across different clients
- **Faster Loading**: Server-cached files load faster than generating from API
- **Storage Management**: Automatic cleanup of old files and size management
- **Simplified Architecture**: No more IndexedDB complexity - just in-memory + server caching

## Quick Start

### 1. Add the Vite Plugin

Update your `vite.config.ts`:

```typescript
import { defineConfig } from 'vite';
import motionCanvas from '@motion-canvas/vite-plugin';
import { motionCanvasNarratorPlugin } from 'motion-canvas-narrator';

export default defineConfig({
  plugins: [
    motionCanvas(),
    // Add the audio storage plugin
    motionCanvasNarratorPlugin({
      audioPath: './audio-cache', // Where to store audio files
      maxFileSize: 50, // Max file size in MB
      allowedMimeTypes: ['audio/mpeg', 'audio/wav', 'audio/ogg']
    }),
  ],
});
```

### 2. Use the ElevenLabs Provider with Server Caching

The standard `createElevenLabsNarrator` now includes server-side caching:

```typescript
import { createElevenLabsNarrator } from 'motion-canvas-narrator';

const narrator = createElevenLabsNarrator({
  apiKey: process.env.ELEVENLABS_API_KEY,
  voiceId: 'your-voice-id',
  
  // Server cache settings (enabled by default)
  enableServerCache: true, // Enable server-side caching
  serverCacheUrl: '/__narrator-audio/', // URL prefix for cached files
});

// Use normally - caching happens automatically
yield* narrator.speak("This will be cached on the server!");
```

## How It Works

1. **Cache Check**: When resolving audio, the system first checks:
   - In-memory cache (fastest)
   - Server cache via Vite HMR
   - If none found, generates via API

2. **Automatic Upload**: When new audio is generated:
   - Creates blob URL for immediate use
   - Uploaded to server via Vite HMR
   - Server stores both audio file and metadata

3. **File Serving**: Server serves cached files at `/__narrator-audio/{filename}`

4. **Cache Management**: 
   - Automatic cleanup of old files
   - Size-based eviction
   - Manual cleanup endpoint at `/__narrator-cleanup`

## Technical Implementation

The system uses **Vite's Hot Module Replacement (HMR)** system for communication between the browser and server, exactly like Motion Canvas does for its exporter. This provides:

- **Reliable Connection**: Uses Vite's built-in WebSocket infrastructure
- **Type Safety**: Proper TypeScript integration with HMR events
- **Performance**: Efficient message passing without custom WebSocket management

## Configuration Options

### Audio Storage Plugin Options

```typescript
interface MotionCanvasNarratorPluginOptions {
  audioPath?: string;        // Directory to store files (default: './audio-cache')
  maxFileSize?: number;      // Max file size in MB (default: 50)
  allowedMimeTypes?: string[]; // Allowed audio formats
}
```

### ElevenLabs Provider Options

```typescript
interface ElevenLabsConfig {
  // Standard ElevenLabs options
  apiKey?: string;
  voiceId: string;
  modelId?: string;
  
  // Server cache options
  enableServerCache?: boolean;  // Enable server caching (default: true)
  serverCacheUrl?: string;      // URL for cached files (default: '/__narrator-audio/')
}
```

## HMR Event Protocol

The system uses these Vite HMR events:

**Client to Server:**
- `narrator:upload-audio` - Upload audio file to server
- `narrator:check-audio` - Check if audio exists on server

**Server to Client:**
- `narrator:upload-success` - Confirm successful upload
- `narrator:upload-error` - Report upload error
- `narrator:audio-exists` - Confirm audio exists
- `narrator:audio-not-found` - Audio not found on server

## File Structure

Server-side files are stored as:
```
audio-cache/
├── 20fac170.mp3         # Audio file (8-char cache key as filename)
├── 20fac170.meta.json   # Metadata file
├── 31a6755c.mp3
├── 31a6755c.meta.json
└── ...
```

**Cache Key Format**: All cache keys are exactly 8 hexadecimal characters (e.g., `20fac170`) generated from a hash of the text content, voice ID, and model ID.

Metadata files contain:
```json
{
  "cacheKey": "20fac170",
  "duration": 3.45,
  "mimeType": "audio/mpeg",
  "fileSize": 55296,
  "fileName": "20fac170.mp3",
  "createdAt": "2024-01-01T12:00:00.000Z",
  "voiceId": "voice-id",
  "modelId": "eleven_flash_v2_5"
}
```

## Cleanup and Maintenance

### Automatic Cleanup
Files older than 30 days are automatically cleaned up when the server starts.

### Manual Cleanup
Visit `/__narrator-cleanup` to trigger manual cleanup of old files.

### Cache Statistics
Monitor cache usage through the console logs:
- Upload confirmations
- Cache hits/misses
- Cleanup operations

## Migration from Previous Versions

To migrate existing projects:

1. Add the vite plugin to your config

2. Update narrator creation (optional):
   ```typescript
   // Before (still works)
   const narrator = createElevenLabsNarrator({ apiKey, voiceId });
   
   // After (with explicit server cache control)
   const narrator = createElevenLabsNarrator({ 
     apiKey, 
     voiceId,
     enableServerCache: true  // Server caching is enabled by default
   });
   ```

Server-side caching is enabled by default, so existing code will automatically benefit from the new caching system.

## Troubleshooting

### WebSocket Connection Issues
- Ensure vite dev server is running
- Check browser console for connection errors
- Verify plugin is properly configured

### Large File Upload Failures
- Check `maxFileSize` setting in plugin config
- Monitor network tab for upload progress
- Verify disk space on server

### Cache Misses
- Check that cache keys are being generated consistently
- Verify WebSocket messages are being sent/received
- Monitor server logs for upload confirmations

## Security Considerations

- Audio files are served with long-term caching headers
- No authentication is implemented (suitable for dev environments)
- Consider adding authentication for production use
- Files are stored with hash-based names (no sensitive data in filenames)

## Example Projects

See `examples/server-cache-example.tsx` for a complete working example demonstrating the server-side caching functionality.
